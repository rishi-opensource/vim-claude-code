" test/test_dispatch.vader
" Vader tests for vim-claude-code v1.0.0
" Run: vim -u test/vimrc -c 'Vader! test/test_dispatch.vader' -c 'qall!'
"
" NOTE: Vader Execute blocks run in command-line context.
" Local variables (l:) are not available â€” use plain variable names or s:.

" ---------------------------------------------------------------------------
" Plugin constants
" ---------------------------------------------------------------------------

Execute (g:claude_code_version is set to 1.1.0):
  Assert exists('g:claude_code_version')
  AssertEqual '1.1.0', g:claude_code_version

" ---------------------------------------------------------------------------
" Util: error / debug / confirm helpers
" ---------------------------------------------------------------------------

Execute (util#error function exists):
  Assert exists('*claude_code#util#error'), 'claude_code#util#error not found'

Execute (util#debug function exists):
  Assert exists('*claude_code#util#debug'), 'claude_code#util#debug not found'

Execute (util#confirm function exists):
  Assert exists('*claude_code#util#confirm'), 'claude_code#util#confirm not found'

Execute (util#debug does not throw when debug=0):
  let g:claude_code_debug = 0
  call claude_code#util#debug('silent test')

Execute (util#debug does not throw when debug=1):
  let g:claude_code_debug = 1
  call claude_code#util#debug('verbose test')
  let g:claude_code_debug = 0

" ---------------------------------------------------------------------------
" Util: visual selection
" ---------------------------------------------------------------------------

Execute (util#visual_selection returns empty string with no selection):
  AssertEqual '', claude_code#util#visual_selection()

" ---------------------------------------------------------------------------
" Util: file context
" ---------------------------------------------------------------------------

Execute (util#file_context returns a string containing File:):
  let ctx = claude_code#util#file_context()
  Assert type(ctx) == v:t_string, 'file_context did not return a string'
  Assert ctx =~# 'File:', 'file_context missing File: prefix'

" ---------------------------------------------------------------------------
" Config: defaults and round-trip
" ---------------------------------------------------------------------------

Execute (config#get returns default command):
  AssertEqual 'claude', claude_code#config#get('command')

Execute (config#get returns default position):
  AssertEqual 'right', claude_code#config#get('position')

Execute (config#get returns default debug = 0):
  AssertEqual 0, claude_code#config#get('debug')

Execute (config#get returns default map_extended_keys = 1):
  AssertEqual 1, claude_code#config#get('map_extended_keys')

Execute (config#get returns default terminal_start_delay = 300):
  AssertEqual 300, claude_code#config#get('terminal_start_delay')

Execute (config#set / config#get round-trip):
  call claude_code#config#set('_test_key', 'hello')
  AssertEqual 'hello', claude_code#config#get('_test_key')

" ---------------------------------------------------------------------------
" Config: buffer-local override takes precedence
" ---------------------------------------------------------------------------

Execute (buffer-local b: override takes precedence over g:):
  let g:claude_code_position = 'top'
  let b:claude_code_position = 'left'
  AssertEqual 'left', claude_code#config#get('position')
  unlet g:claude_code_position
  unlet b:claude_code_position

" ---------------------------------------------------------------------------
" Git root detection
" ---------------------------------------------------------------------------

Execute (git#root returns a string):
  let root = claude_code#git#root()
  Assert type(root) == v:t_string, 'git#root did not return a string'

Execute (git#clear_cache does not error):
  call claude_code#git#clear_cache()

" ---------------------------------------------------------------------------
" Window: position resolution
" ---------------------------------------------------------------------------

Execute (window#resolve_position maps bottom to botright):
  AssertEqual 'botright', claude_code#window#resolve_position('bottom')

Execute (window#resolve_position maps right to vertical botright):
  AssertEqual 'vertical botright', claude_code#window#resolve_position('right')

Execute (window#resolve_position passes through unknown values):
  AssertEqual 'myval', claude_code#window#resolve_position('myval')

" ---------------------------------------------------------------------------
" Terminal module presence
" ---------------------------------------------------------------------------

Execute (terminal#toggle function exists):
  Assert exists('*claude_code#terminal#toggle'), 'terminal#toggle not found'

Execute (terminal#on_close function exists):
  Assert exists('*claude_code#terminal#on_close'), 'terminal#on_close not found'

" ---------------------------------------------------------------------------
" Meta commands: version / doctor
" ---------------------------------------------------------------------------

Execute (meta_commands#version function exists):
  Assert exists('*claude_code#meta_commands#version'), 'meta_commands#version not found'

Execute (meta_commands#doctor function exists):
  Assert exists('*claude_code#meta_commands#doctor'), 'meta_commands#doctor not found'
